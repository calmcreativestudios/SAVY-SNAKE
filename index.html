<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Savy Snake Module</title>

  <!-- Source Sans Pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --ink:#000000;
      --game:#000000;
      --ui:#000000;
    }
    html,body{margin:0; padding:0; background:var(--bg); color:var(--ui); font-family:"Source Sans 3","Source Sans Pro",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* MODULE WRAP (embed this whole thing in Readymag) */
    .savy-snake{
      display:flex;
      align-items:flex-start;
      gap:48px;
      /* You can control overall placement in Readymag; keep this minimal */
    }

    /* GAME BOX */
    .gameBox{
      width:900px;
      height:900px;
      background:var(--game);
      border:6px solid var(--ink);
      box-sizing:border-box;
      display:grid;
      place-items:center;
    }

    canvas{
      width:100%;
      height:100%;
      display:block;
      background:transparent;
      image-rendering: pixelated;
    }

    /* RIGHT UI */
    .sideUI{
      min-width:220px;
      padding-top:8px; /* aligns SCORE with top edge visually */
      user-select:none;
    }

    .score{
      font-size:16px;
      letter-spacing:0.5px;
      text-transform:uppercase;
    }

    .enterShop{
      margin-top:44px;
      font-size:16px;
      letter-spacing:0.5px;
      text-transform:uppercase;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms linear;
      cursor:pointer;
      display:inline-block;
    }

    .enterShop.unlocked{
      opacity:1;
      pointer-events:auto;
    }

    /* subtle flash on unlock */
    .enterShop.flash{
      animation: flash 0.65s linear 1;
    }
    @keyframes flash{
      0%{opacity:0.15;}
      12%{opacity:1;}
      24%{opacity:0.15;}
      36%{opacity:1;}
      48%{opacity:0.15;}
      60%{opacity:1;}
      100%{opacity:1;}
    }

    /* RESPONSIVE: on smaller screens, make it near full width */
    @media (max-width: 980px){
      .savy-snake{
        flex-direction:column;
        gap:18px;
      }
      .gameBox{
        width:min(94vw, 900px);
        height:min(94vw, 900px);
      }
      .sideUI{
        padding-top:0;
      }
      .enterShop{
        margin-top:16px;
      }
    }
  </style>
</head>
<body>

  <!--
    Drop this block into Readymag (Embed/Code block).
    If Readymag already has page nav/logo, keep only this module.
  -->
  <div class="savy-snake" id="savySnakeModule">
    <div class="gameBox" aria-label="Savy Snake game">
      <canvas id="game" width="900" height="900"></canvas>
    </div>

    <div class="sideUI">
      <div class="score" id="scoreText">SCORE: 00</div>
      <div class="enterShop" id="enterShop">ENTER SHOP</div>
    </div>
  </div>

<script>
(() => {
  /***********************
   * SETTINGS YOU EDIT
   ***********************/
  const UNLOCK_SCORE = 22;
  const DISCOUNT_SCORE = 100; // later
  const SHOP_URL = ""; // <-- Put your shop URL here. If empty, it won't redirect.

  // Game feel (faster than the earlier test)
  const GRID = 28;                 // grid size (pixel/block feel)
  const START_MS = 85;             // base speed (lower = faster)
  const MIN_MS = 55;               // max speed cap
  const SPEEDUP_EVERY = 5;         // speed up every N points
  const SPEEDUP_MS = 4;            // reduce interval by this much

  /***********************
   * SVG LOGO (food)
   * IMPORTANT: kept smooth (no pixelation)
   ***********************/
  const SAVY_SVG = `<?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 27.5.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 1186.6 508.1" style="enable-background:new 0 0 1186.6 508.1;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#010101;}
</style>
<g>
	<path class="st0" d="M72.9,404.1c0,0-16.6,4.9-22.6-12.5c-5.2-15.2,7.4-26.8,7.4-26.8l17.3-16.1c0,0-21,0.8-42.9,23.5
		c-28.4,29.4-12.1,60.6,13,75c26.7,15.3,53.5-1,53.5-1L72.9,404.1z"/>
	<path class="st0" d="M186.4,315.2c0,0,16.6-4.9,22.6,12.5c5.2,15.2-7.4,26.8-7.4,26.8l-17.3,16.1c0,0,21-0.8,42.9-23.5
		c28.4-29.4,12.1-60.6-13-75c-26.7-15.3-53.5,1-53.5,1L186.4,315.2z"/>
	<path class="st0" d="M287.7,141.4c0,0-33.7-49.2-105.3-56.8c-71.6-7.6-123.8,45.7-123.8,45.7s6.8,9,14.1,19.6
		c0,0,46.1-41.2,101.3-36.2c0,0,48.7,2.5,85.4,52L287.7,141.4z"/>
	<path class="st0" d="M591.2,34.3c0,0-165.8,111-277.6,288.4c-72.6,115.1-135.2,185-195.9,185c0,0-31.7,1-41-7.9
		c0,0-24.4-22.9,4.1-65.1c0,0,20-25.6,66.3-48.1l23.5-43.7c0,0-81,23.4-114.2,82.6c0,0-28.6,48.4,4.2,77.7
		c22.9,20.5,55.4,16.7,55.4,16.7s91.9,7.2,201.2-176.3C317.2,343.5,431.7,167.5,591.2,34.3z"/>
	<path class="st0" d="M757.3,17.4c0,0-219.1,111.3-374.6,329.5c0,0-67.9,93.5-126.9,126.4c0,0-34.2,19.8-57.6,14.9
		c0,0-35.4-5.7-22.2-53.9c0,0,9.4-27.4,45.4-50.6l17.8-43c0,0-68.4,31.1-87.9,75.1c0,0-15.2,34.6,0.1,55.4
		c0,0,13.5,23.1,55.2,20.7c0,0,41.5,1.7,89.6-39c0,0,65.6-47,127.7-134.8c0,0,130.4-196.9,333.8-312.7
		C757.7,5.6,769.1,0,757.3,17.4z"/>
	<path class="st0" d="M861.3,25.5c0,0-134.2,79.2-275.7,253.5c-107.9,133-153.8,170.9-206.8,188.5c0,0,25.4-22,51.3-64.7
		c0,0-29.4,34.2-76.9,62.4c0,0-29.5,20.9-60.2,20.2c0,0-18.8-0.4-26.1-10.7c0,0-10.2-14.8,0.6-37.5
		c0,0,10.2-26,40.4-49.8c0,0,14.8-9.6,30.4-14.8l24.4-45.8c0,0-55.8,7.6-95.3,58.6c0,0-34.1,45.5-9.4,78.8
		c0,0,16.1,28.3,60.9,22.5c0,0,50.8-5.4,102.1-44.2c0,0,40.9-29.2,114.2-122.4c0,0,127.3-162.8,227.5-230.5
		C862.6,12.3,874.7,5.9,861.3,25.5z"/>
	<path class="st0" d="M969.4,21.4c0,0-229.6,121.3-357.1,303.7c0,0-80.5,120.9-106.7,147.6c0,0-20.9,24-20.6,0.5
		c0,0-0.4-22.9,40.1-103.5c0,0,51.1-90.3,145.5-178.7l-10.4-2.7c0,0-107.1,100.1-156.5,200.3c0,0-45.9,92-16.8,104.6
		c0,0,18,9.5,54.8-33.8c0,0,25.3-25.8,73.5-99.9c0,0,156.7-219.4,353.8-326.7C969,33.4,982.4,27.1,969.4,21.4z"/>
	<path class="st0" d="M1078.8,23.8c0,0-205.6,99.2-329.2,278.7c0,0-69.1,100.4-122.9,149.2c0,0-19.9,22.5-18.5,7
		c0,0-0.2-16.9,44.2-95.1c0,0,50.9-83.7,141.4-158l-9.8-4.2c0,0-95.1,78.3-154.9,178.8c0,0-56.2,87.8-37.1,103.2
		c0,0,12.7,20.1,84.6-48.8c0,0,60.9-53.1,125.1-144.8c0,0,133.8-182.8,280.9-259.6C1082.5,30.1,1095.1,23.9,1078.8,23.8z"
		/>
	<path class="st0" d="M1173.1,19.5c0,0-176.8,79.2-296.5,270.8c0,0-56.1,89.3-135,172.9c0,0-22.1,29.6-23,0.1
		c0,0,0.2-21.1,36.7-84.5c0,0,52.1-80.2,124.4-137.8l-9.7-3c0,0-88.4,66-146.6,156.8c0,0-54.1,79.4-30.3,96.3
		c0,0,18,15,63.5-22.3c0,0,69.5-52.3,149.6-174.5c0,0,119.8-181.7,268.4-258.3C1174,36,1194.2,26.7,1173.1,19.5z"/>
</g>
</svg>`;

  function svgToImage(svgText){
    const encoded = encodeURIComponent(svgText)
      .replace(/'/g, "%27")
      .replace(/"/g, "%22");
    const src = `data:image/svg+xml;charset=utf-8,${encoded}`;
    const img = new Image();
    img.decoding = "async";
    img.src = src;
    return img;
  }

  const foodImg = svgToImage(SAVY_SVG);

  /***********************
   * CANVAS SETUP
   ***********************/
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d", { alpha:true });

  // Ensure crisp blocks
  function setCrisp(){
    ctx.imageSmoothingEnabled = false;
    // Safari aliases
    ctx.webkitImageSmoothingEnabled = false;
    ctx.mozImageSmoothingEnabled = false;
  }

  // Fit canvas to its displayed size (keeps pixel look)
  function resizeCanvasToBox(){
    const box = canvas.parentElement.getBoundingClientRect();
    const dpr = Math.min(2, window.devicePixelRatio || 1);

    const px = Math.floor(box.width * dpr);
    const py = Math.floor(box.height * dpr);

    if (canvas.width !== px || canvas.height !== py){
      canvas.width = px;
      canvas.height = py;
      setCrisp();
      draw(true);
    }
  }

  window.addEventListener("resize", resizeCanvasToBox);

  /***********************
   * UI
   ***********************/
  const scoreText = document.getElementById("scoreText");
  const enterShop = document.getElementById("enterShop");

  function setScoreUI(n){
    const s = String(n).padStart(2, "0");
    scoreText.textContent = `SCORE: ${s}`;
  }

  function unlockUI(){
    if (!enterShop.classList.contains("unlocked")){
      enterShop.classList.add("unlocked");
      // subtle flash
      enterShop.classList.remove("flash");
      void enterShop.offsetWidth; // restart anim
      enterShop.classList.add("flash");
    }
  }

  enterShop.addEventListener("click", () => {
    // Keep playing is allowed; this only performs the action.
    if (!enterShop.classList.contains("unlocked")) return;

    if (SHOP_URL && typeof SHOP_URL === "string"){
      window.location.href = SHOP_URL;
    } else {
      // Readymag alternative: hook this into whatever action you want later
      // e.g. window.parent.postMessage({ type:"SAVY_ENTER_SHOP" }, "*");
      console.log("ENTER SHOP clicked. Set SHOP_URL in code to redirect.");
    }
  });

  /***********************
   * GAME STATE
   ***********************/
  let snake = [];
  let dir = {x:1, y:0};
  let nextDir = {x:1, y:0};
  let food = {x:10, y:10};
  let score = 0;

  let tickMs = START_MS;
  let lastTime = 0;
  let acc = 0;
  let running = false;
  let dead = false;

  // visual flash on unlock (brief white ring)
  let unlockFlashT = 0; // ms remaining

  function cellSize(){
    // integer cell size for crispness
    return Math.floor(Math.min(canvas.width, canvas.height) / GRID);
  }

  function reset(){
    score = 0;
    setScoreUI(score);
    tickMs = START_MS;
    dead = false;
    running = false;
    unlockFlashT = 0;

    const mid = Math.floor(GRID/2);
    snake = [
      {x: mid, y: mid},
      {x: mid-1, y: mid},
      {x: mid-2, y: mid},
      {x: mid-3, y: mid},
    ];
    dir = {x:1,y:0};
    nextDir = {x:1,y:0};
    food = spawnFood();
    enterShop.classList.remove("unlocked","flash");
    draw(true);
  }

  function spawnFood(){
    for (let i=0; i<600; i++){
      const x = Math.floor(Math.random()*GRID);
      const y = Math.floor(Math.random()*GRID);
      if (!snake.some(s => s.x===x && s.y===y)) return {x,y};
    }
    return {x:0,y:0};
  }

  function step(){
    if (dead) return;

    dir = nextDir;
    const head = snake[0];
    const nx = head.x + dir.x;
    const ny = head.y + dir.y;

    // wall
    if (nx < 0 || ny < 0 || nx >= GRID || ny >= GRID){
      dead = true; running = false;
      return;
    }
    // self
    if (snake.some((s, idx) => idx!==0 && s.x===nx && s.y===ny)){
      dead = true; running = false;
      return;
    }

    snake.unshift({x:nx, y:ny});

    // eat
    if (nx === food.x && ny === food.y){
      score += 1;
      setScoreUI(score);

      // speed up a bit
      if (score % SPEEDUP_EVERY === 0){
        tickMs = Math.max(MIN_MS, tickMs - SPEEDUP_MS);
      }

      // unlock at 22 (flash + show ENTER SHOP)
      if (score === UNLOCK_SCORE){
        unlockUI();
        unlockFlashT = 650; // ms
      }
      if (score > UNLOCK_SCORE){
        unlockUI();
      }

      // discount at 100 later
      if (score === DISCOUNT_SCORE){
        // placeholder hook for later
        // e.g. show small text / badge / message (not implemented yet)
      }

      food = spawnFood();
    } else {
      snake.pop();
    }
  }

  /***********************
   * DRAW
   ***********************/
  function draw(force=false){
    // clear black
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const cs = cellSize();
    const pad = 0; // hard pixels

    // snake (white blocks)
    ctx.fillStyle = "#fff";
    for (let i=0; i<snake.length; i++){
      const s = snake[i];
      const x = s.x * cs;
      const y = s.y * cs;
      // slight inset for definition
      ctx.fillRect(x + 1, y + 1, cs - 2, cs - 2);
    }

    // food (smooth SVG logo)
    // keep it inside a cell, scale to fit while preserving aspect ratio
    const fx = food.x * cs;
    const fy = food.y * cs;

    // draw food only if image ready
    if (foodImg.complete && foodImg.naturalWidth){
      const target = cs * 0.9;
      const iw = foodImg.naturalWidth;
      const ih = foodImg.naturalHeight;
      const scale = Math.min(target / iw, target / ih);
      const dw = iw * scale;
      const dh = ih * scale;

      const dx = fx + (cs - dw)/2;
      const dy = fy + (cs - dh)/2;
      ctx.drawImage(foodImg, dx, dy, dw, dh);
    } else {
      // fallback: tiny white square until logo loads
      ctx.fillStyle = "#fff";
      ctx.fillRect(fx + cs*0.35, fy + cs*0.35, cs*0.3, cs*0.3);
      ctx.fillStyle = "#fff";
    }

    // unlock flash: subtle white border pulse (not celebratory)
    if (unlockFlashT > 0){
      ctx.save();
      ctx.globalAlpha = 0.22;
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = Math.max(4, Math.floor(cs*0.15));
      ctx.strokeRect(ctx.lineWidth/2, ctx.lineWidth/2, canvas.width-ctx.lineWidth, canvas.height-ctx.lineWidth);
      ctx.restore();
    }

    // death state (very minimal)
    if (dead){
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#fff";
      ctx.font = `${Math.floor(canvas.width*0.05)}px "Source Sans 3", Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("RESTART", canvas.width/2, canvas.height/2);
      ctx.font = `${Math.floor(canvas.width*0.025)}px "Source Sans 3", Arial`;
      ctx.fillText("Press R or tap", canvas.width/2, canvas.height/2 + Math.floor(canvas.width*0.06));
      ctx.restore();
    }
  }

  /***********************
   * LOOP (fixed timestep)
   ***********************/
  function loop(t){
    if (!lastTime) lastTime = t;
    const dt = t - lastTime;
    lastTime = t;

    if (running && !dead){
      acc += dt;
      while (acc >= tickMs){
        step();
        acc -= tickMs;
      }
    }

    if (unlockFlashT > 0){
      unlockFlashT = Math.max(0, unlockFlashT - dt);
    }

    draw();
    requestAnimationFrame(loop);
  }

  /***********************
   * INPUT
   ***********************/
  function setDirection(dx, dy){
    // block reversal
    if (dx === -dir.x && dy === -dir.y) return;
    nextDir = {x:dx,y:dy};
    if (!running && !dead) running = true;
  }

  // keyboard
  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === "arrowup" || k === "w"){ e.preventDefault(); setDirection(0,-1); }
    else if (k === "arrowdown" || k === "s"){ e.preventDefault(); setDirection(0,1); }
    else if (k === "arrowleft" || k === "a"){ e.preventDefault(); setDirection(-1,0); }
    else if (k === "arrowright" || k === "d"){ e.preventDefault(); setDirection(1,0); }
    else if (k === "r"){
      e.preventDefault();
      reset();
      running = true;
    }
  }, {passive:false});

  // touch swipe (mobile)
  let sx=0, sy=0, touching=false;
  canvas.addEventListener("touchstart", (e) => {
    if (!e.touches || e.touches.length !== 1) return;
    touching = true;
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
  }, {passive:true});

  canvas.addEventListener("touchmove", (e) => {
    // prevent page scroll while swiping on the game
    if (touching) e.preventDefault();
  }, {passive:false});

  canvas.addEventListener("touchend", (e) => {
    if (!touching) return;
    touching = false;

    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
    if (!t) return;

    const dx = t.clientX - sx;
    const dy = t.clientY - sy;

    const adx = Math.abs(dx);
    const ady = Math.abs(dy);
    const threshold = 14;

    if (adx < threshold && ady < threshold){
      // tap-to-restart if dead
      if (dead){
        reset();
        running = true;
      }
      return;
    }

    if (adx > ady){
      setDirection(dx > 0 ? 1 : -1, 0);
    } else {
      setDirection(0, dy > 0 ? 1 : -1);
    }
  }, {passive:true});

  // start when logo image is ready (not required, but avoids first-frame blank food)
  function init(){
    resizeCanvasToBox();
    setCrisp();
    reset();
    requestAnimationFrame(loop);
  }

  if (foodImg.complete){
    init();
  } else {
    foodImg.onload = init;
    foodImg.onerror = init;
  }
})();
</script>

</body>
</html>
