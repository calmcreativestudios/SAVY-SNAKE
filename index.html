<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    #wrap { position:fixed; inset:0; display:grid; place-items:center; background:#000; touch-action:none; }
    canvas { display:block; image-rendering:pixelated; outline:none; }
    #hud { position:fixed; inset:0; pointer-events:none; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#fff; }
    #msg {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      text-align:center; font-weight:700; line-height:1.25;
      opacity:0; transition:opacity 140ms ease; white-space:pre-line;
    }
    #msg.show { opacity:1; }
    #score { position:absolute; left:12px; top:10px; font-size:14px; opacity:.9; }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c" tabindex="0"></canvas>
  </div>
  <div id="hud">
    <div id="score"></div>
    <div id="msg"></div>
  </div>

  <script>
    (() => {
      // ---- HARD RESET if this embed was injected multiple times ----
      // Hosts often re-run scripts on preview/publish without fully unloading.
      if (window.__EMBED_GAME_CLEANUP__) {
        try { window.__EMBED_GAME_CLEANUP__(); } catch (_) {}
      }

      const wrap = document.getElementById('wrap');
      const canvas = document.getElementById('c');
      const ctx = canvas.getContext('2d', { alpha: false });

      const scoreEl = document.getElementById('score');
      const msgEl = document.getElementById('msg');

      const BASE_W = 800, BASE_H = 800;

      // ---- State ----
      const state = {
        started: false,
        running: false,
        gameOver: false,
        score: 0
      };

      // ---- UI ----
      function showMessage(text) {
        msgEl.textContent = text;
        msgEl.classList.add('show');
      }
      function hideMessage() {
        msgEl.classList.remove('show');
        msgEl.textContent = '';
      }

      // ---- Game object (demo) ----
      function Game() {
        return {
          x: BASE_W / 2,
          y: BASE_H / 2,
          vx: 0,
          vy: 0,
          size: 18,
          speed: 1.0
        };
      }
      let game = Game();

      function startGame() {
        if (state.started) return;
        state.started = true;
        state.running = true;
        hideMessage();
      }

      function restart() {
        state.started = true;      // restart implies started
        state.running = true;
        state.gameOver = false;
        state.score = 0;
        keys.clear();
        game = Game();
        hideMessage();
      }

      function gameOver() {
        state.running = false;
        state.gameOver = true;
        showMessage("Restart\nPress Space or Tap to Restart");
      }

      // ---- Resize / Fit ----
      function resize() {
        const rect = wrap.getBoundingClientRect();
        const scale = Math.min(rect.width / BASE_W, rect.height / BASE_H);

        const cssW = Math.floor(BASE_W * scale);
        const cssH = Math.floor(BASE_H * scale);

        canvas.width = BASE_W;
        canvas.height = BASE_H;

        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
      }

      const ro = new ResizeObserver(resize);
      ro.observe(wrap);
      resize();

      // ---- Input (capture + stopPropagation so host canâ€™t steal keys) ----
      const keys = new Set();
      const BLOCK_KEYS = new Set([
        "ArrowUp","ArrowDown","ArrowLeft","ArrowRight",
        " ","Space","Spacebar",
        "w","a","s","d","W","A","S","D"
      ]);

      function isRestartKey(e) {
        // Prefer e.code, fall back to e.key
        const code = e.code || "";
        const key = e.key || "";
        return (
          code === "Space" || key === " " || key === "Space" || key === "Spacebar" ||
          code === "KeyR" || key === "r" || key === "R"
        );
      }

      function isMovementKey(e) {
        const k = e.key || "";
        const c = e.code || "";
        return (
          k.startsWith("Arrow") ||
          c === "KeyW" || c === "KeyA" || c === "KeyS" || c === "KeyD" ||
          k === "w" ||
